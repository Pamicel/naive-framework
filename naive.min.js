"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}var app=function(){var curry=function(a){var b=a.length;return function c(){for(var d=arguments.length,e=Array(d),f=0;f<d;f++)e[f]=arguments[f];return e.length<b?c.bind.apply(c,[null].concat(e)):a.call.apply(a,[null].concat(e))}},prop=curry(function(a,b){return b[a]}),Store=function(){var a={},b={},c=curry(function(a,b,c){var d=Object.getOwnPropertyDescriptor(b,c);Object.defineProperty(a,c,d)}),d=function(a,b){return Object.keys(b).map(c(a,b)),a},e=function(a,c){b[a]&&b[a].map(function(a){return a[1](c)})},f=curry(function(a,c,d){if("function"!=typeof d)throw new Error("Callback not a function");if("string"!=typeof c)throw new Error("Name not a string");b[c]||(b[c]=[]),b[c].push([a,d])}),g=curry(function(a,c,d){b[c]&&(b[c]=b[c].filter(function(b){return b[0]!==a||b[1]!==d}))}),h=function(a){b[a]&&delete b[a]},i=function(b,c){a[b]=c,e(b,c)},j=function(b){if(a[b]){var c=Object.getOwnPropertyDescriptor(a,b);c.get||c.set?a[b]=null:delete a[b]}h(b)};return{initialise:function c(b){if(0!==Object.keys(a).length)throw Error("Global state initialisation error : global state has already been mutated");d(a,b)},create:function e(b){var c=f(b),d=g(b);return{set:i,remove:j,watch:c,unwatch:d,get state(){return Object.assign({},a)}}},remove:function c(a){Object.keys(b).map(function(c){return b[c]=b[c].filter(function(b){return b[0]!==a})})}}}(),resetAlert=function(){var a=document.getElementById("alert"),b=document.querySelector("#alert .alert__buttons__close"),c=document.querySelector("#alert .alert__buttons__action"),d=document.querySelector("#alert .alert__message");a.classList.remove("on"),c.classList.remove("on"),c.onclick=void 0,b.onclick=void 0,c.innerHTML="",b.innerHTML="",d.innerHTML="",document.body.style.overflow=""},displayAlert=function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"Ok",c=2<arguments.length?arguments[2]:void 0,d=document.getElementById("alert"),e=document.querySelector("#alert .alert__buttons__close"),f=document.querySelector("#alert .alert__message");requestAnimationFrame(function(){d.classList.add("on","enter"),requestAnimationFrame(function(){d.classList.remove("enter")})}),"object"===_typeof(b)?(e.innerHTML=b.buttonText,e.onclick=function(a){return a.stopPropagation(),b.fn?b.fn().then(function(a){return resetAlert(),Promise.resolve(a)}):void resetAlert()}):(e.innerHTML=b,e.onclick=function(a){a.stopPropagation(),resetAlert()});var g=document.querySelector("#alert .alert__buttons__action");c&&c.fn&&(!0===c.singleButton?g=e:(g.classList.add("on"),g.innerHTML=c.buttonText),g.onclick=function(a){return c.fn(a).then(function(){return resetAlert()})}),f.innerHTML=a,document.body.style.overflow="hidden",e.focus();var h=function(a){"Escape"===a.key&&(document.body.removeEventListener("keydown",h),"object"===_typeof(b)&&b.fn?b.fn().then(function(){resetAlert()}):resetAlert())};document.body.addEventListener("keydown",h)},ComponentsProxy=function(){function a(a){return fetch("/comp",{body:JSON.stringify({name:a}),method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"}}).then(function(a){return a.json()}).catch(function(){return Promise.reject("Probl\xE8me lors de la connection au server")}).then(function(a){return a.info.component})}function b(a){var b=a.hasOwnProperty("template")&&a.hasOwnProperty("script");return b?Object.assign({},a):null}function c(a,b){(!d(a)||e(a,b))&&(f[a]=b)}function d(a){return f.hasOwnProperty(a)}function e(a,b){var c=b.template,e=b.script,g=b.restricted;return!d(a)||void 0!==c&&f[a].template!==c||void 0!==e&&f[a].script!==e||void 0!==g&&f[a].restricted!==g}var f={};return{get:function(e){return d(e)?Promise.resolve(Object.assign({},f[e])):a(e).then(function(a){var d=b(a);return a.name===e&&c(e,a),Promise.resolve(d)}).catch(function(){return Promise.reject(new Error("Could not load component. Request : { name: ".concat(e," }")))})},restrict:function(){for(var a in f)f[a].restricted&&delete f[a]}}}(),components=ComponentsProxy,mountSelector=curry(function(a,b){var c="#"+a.id+" ",d=document.querySelectorAll(c+b);return d.length&&1===d.length?d[0]:d}),createEmiters=function(a){return a?function(){var b=Array.prototype.slice.call(arguments),c=b[0];if(a[c])return a[c].apply(null,b.slice(1));throw Error("Emiter ".concat(c," not defined."))}:void 0},summonComponent=curry(function(mount,dom,component){var $=mountSelector(mount),$mount=mount,$name=component.name,$options=component.opt,$emit=createEmiters(component.on),$life={},$alert=displayAlert,$router=appInterface.router,$store=Store.create(dom),$open=eval(component.script)();return{open:$open,life:$life}}),templateToDOM=function(a){var b,c=new DOMParser;return b=c.parseFromString(a,"text/html"),b=1<=b.body.childNodes.length?b.body.firstChild:null,b},attachNewComponent=curry(function(a,b){a.firstChild&&a.removeChild(a.firstChild),a.appendChild(b)}),spawner=curry(function(a,b,c,d,e){var f=d.dom=d.dom||templateToDOM(d.template);a.name!=d.comp&&c(f);var g=d.logic=d.logic||b(f,d),h=g.open(e),i=function(a){return Promise.resolve(Object.assign({interface:a},d))};return h instanceof Promise?h.then(i):i(h)}),clearMount=function(a,b){return function(){for("function"==typeof b.close&&b.close(),b.close instanceof Array&&b.close.map(function(a){"function"==typeof a&&a()});a.firstChild;)a.removeChild(a.firstChild)}},createDoormanUtility=function(a){return function(b,c){function d(a){return i.hasOwnProperty(a)?i[a]:{}}function e(a,b){a===b.dom.getAttribute("name")&&(i[a]||(i[a]={dom:b.dom,logic:b.logic,restricted:b.restricted}))}function f(a){delete j.close,j.close=function(){Store.remove(a.dom),a.life&&a.life.close&&("function"==typeof a.life.close?a.life.close():a.life.close instanceof Array&&a.life.close.map(function(a){"function"==typeof a&&a()})),a.logic&&a.logic.life&&a.logic.life.close&&("function"==typeof a.logic.life.close?a.logic.life.close():a.logic.life.close instanceof Array&&a.logic.life.close.map(function(a){"function"==typeof a&&a()}))}}var g=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};for(var h in c=Object.freeze(c),g=Object.freeze(g),c)if(!c[h].comp||"string"!=typeof c[h].comp)throw new Error("Some routes don't specify a component name in 'comp'");var i={},j={get name(){return b.firstChild?b.firstChild.getAttribute("name"):void 0}},k=clearMount(b,j),l=summonComponent(b),m=attachNewComponent(b),n=spawner(j,l,m),o=function(b,c){b&&b.opt?b.opt:{};return c.$query=b.query||"",a.get(b.comp).then(function(a){var e=Object.assign({},a,d(b.comp),b);return n(e,c)}).then(function(a){var c=a.life;return c&&c.open&&c.open(),f(a),e(b.comp,a),Promise.resolve(a.interface)})},p=function(a,b){return Object.assign({},b[a.route],a)},q=function c(a,b){return function(c){var d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return("string"==typeof c||void 0===c)&&(c={route:c}),c.route&&b[c.route]||(c.route=a.default),c.route||1!==Object.keys(b).length||(c.route=b[Object.keys(b)[0]]),b[c.route]?(k(),o(p(c,b),d)):Promise.reject(new Error("No route specified"))}}(g,c);return{load:q,unload:k,restrict:function(){for(var b in a.restrict(),i)i[b].restricted&&delete i[b]},preload:function(b){b instanceof Array?b.map(function(b){a.get(b)}):a.get(name)}}}},Doorman=createDoormanUtility(ComponentsProxy),Router=function(a,b,c){function d(){var a={route:window.location.pathname.split("/")[1],query:window.location.search.split("?")[1]};a.route||(a=e(c.home));var b=window.location.origin+"/"+a.route;a.query&&(b+="?"+a.query),history.replaceState(a,null,b),h.load(a)}var e=function(a){return"string"==typeof a?{route:a}:a},f=curry(function(a,b,c){var d=window.location.origin+"/"+b.route;b.query&&(d+="?"+b.query),b.hash&&(d+="#"+b.hash);var e=history.state;return delete e.previous,b.previous=e,history.pushState(b,null,d),resetAlert(),Promise.resolve(c)}),g=f(c),h=Doorman(a,b,c);window.onpopstate=function(a){resetAlert(),"/"===window.location.pathname||null===a.state?d():h.load(a.state)};var i=function(a,b){return h.load(a,b).then(g(e(a)))};if(!c.home)throw new Error("Router could not be created, settings.home not defined");return d(),Object.assign(h,{to:i,home:function a(){return i(c.home)}})},appInterface={components:components};return Doorman(document.getElementById("mount-main"),{main:{comp:"__main__"}}).load("main").then(function(a){Object.assign(appInterface,a)}).catch(function(a){throw new Error(a)}),appInterface}();
